<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>	
	<title>wForms 3.0 - Repeat Behavior Test Suite with SaveResume Simulation</title>
	<meta name="Description" content="wForms is an open-source, unobtrusive javascript library that adds commonly needed behaviors to traditional web forms without the need for any programming skills." />
	<meta http-equiv="Keywords" content="form, web form, html form, online form, wForms, input validation, field validation, javascript library" />
	
	<script type="text/javascript" src="jsunit/app/jsUnitCore.js"></script>
	
	<link href="../css/wforms-jsonly.css" type="text/css" rel="stylesheet" />
    <link href="../css/wforms-layout.css" type="text/css" rel="stylesheet" />
	
	<script type="text/javascript" src="../lib/base2/v1.0.1/src/base2.js"></script>
	<script type="text/javascript" src="../lib/base2/v1.0.1/src/base2-dom.js"></script>
	<script type="text/javascript" src="../wforms_core.js"></script>
	<script type="text/javascript" src="../wforms_repeat.js"></script>	
	<script type="text/javascript" src="../wforms_hint.js"></script>	
	<script type="text/javascript" src="../wforms_validation.js"></script>	
   
	<script type="text/javascript">
		wFORMS.behaviors.repeat.onRepeat = function(n) {
			
			return; 
		
			var form = document.getElementById('testRepeatForm');
			var f=form.getElementsByTagName('input');
			for(var i=0;i<f.length;i++) {
				if(f[i].id && f[i].id.indexOf(wFORMS.behaviors.repeat.ID_SUFFIX_COUNTER)==-1 && f[i].type!='button') {
					f[i].value='id='+f[i].id;
				}
			}
		}
	</script>
	
	<script type="text/javascript">
	
	wFORMS.behaviors.repeat.instance.prototype.onApply = function() {
		setUpPageStatus = 'complete';
	} 
	
	function setUpPage() {}
  
  	function setUp() {  }
	
	function tearDown() {}
	
     // disabled, breaks other tests in IE (Not sure why)
	function _testApplyTo() {
		var i=0;
		document.getElementById('testRepeatForm').querySelectorAll(wFORMS.behaviors.repeat.SELECTOR_REPEAT).forEach(
			function(elem){			
				assertNotUndefined('Instance should be set',wFORMS.instances['repeat'][i]);
				assertNotUndefined('Instance should be set',wFORMS.instances['repeat'][i].target);
				i++;
			}
		);
	}

	function testInputRepeatRemoveReindex() {
		
		//Make two copies of test4 input
		var bInstance = wFORMS.getBehaviorInstance(document.getElementById('test4'), 'repeat');
		
		var originalElement = document.getElementById('test4');
		originalElement.value="123";
		assertNotNull(originalElement);
		
		bInstance.run();
		bInstance.run();
		
		//Simulate Save&Resume by killing the cache
		delete bInstance.cache['test4'];
		//
		
		//Verify indices
		originalElement = document.getElementById('test4[0]');
		assertNotNull(originalElement.id);
		assertEquals("123",originalElement.value);

		var repeatedElement1 = document.getElementById('test4[1]');
		repeatedElement1.value="456";
		assertNotNull(repeatedElement1.id);		
		
		var repeatedElement2 = document.getElementById('test4[2]');
		repeatedElement2.value="789";
		assertNotNull(repeatedElement2.id);		
		
		//Delete middle ([1]) repeated element
		var mockClick = {type:"click",preventDefault: function(){}};
		bInstance.onRemoveLinkClick(mockClick,document.getElementById(repeatedElement1.id+'-wfDL'));		
		
		//Indices should auto-reindex to maintain consistancy
		var repeatedElement = document.getElementById('test4[1]');
		assertNotNull("Repeated element [1] not found",repeatedElement);
		assertNotNull(repeatedElement.id);
		//Verify that the content in the second repeated field is presevered 
		//after first section's removal
		assertEquals("789",repeatedElement.value);
	}	

	function testNestedRepeat2(){
		//Make two copies of nestedTest2 parent div
		var bParentInstance = wFORMS.getBehaviorInstance(document.getElementById('nestedTest2'), 'repeat');
		bParentInstance.run();
		bParentInstance.run();
		
		//Make two copies of child field of second copy of nestedTest2 parent div
		var bChildOfSecondCopyOfParentInstance = wFORMS.getBehaviorInstance(document.getElementById('nestedTest5[1]'), 'repeat');
		bChildOfSecondCopyOfParentInstance.run();
		bChildOfSecondCopyOfParentInstance.run();
		
		//Verify parent indices
		var originalElement = document.getElementById('nestedTest2[0]');
			assertNotNull(originalElement.id);
		var repeatedElement1 = document.getElementById('nestedTest2[1]');
			assertNotNull(repeatedElement1.id);		
		var repeatedElement2 = document.getElementById('nestedTest2[2]');
			assertNotNull(repeatedElement2.id);		
			assertEquals("2",document.getElementById('nestedTest2[0]-RC').value);
		
		//Verify child indices
		var originalChildElement = document.getElementById('nestedTest5[1][0]');
			assertNotNull(originalChildElement.id);
		var repeatedChildElement1 = document.getElementById('nestedTest5[1][1]');
			assertNotNull(repeatedChildElement1.id);		
		var repeatedChildElement2 = document.getElementById('nestedTest5[1][2]');
			assertNotNull(repeatedChildElement2.id);		
			assertEquals("2",document.getElementById('nestedTest5[1][0]-RC').value);

		delete bParentInstance.cache['nestedTest2'];
		delete bChildOfSecondCopyOfParentInstance.cache['nestedTest5[1]'];
		
		//Delete middle ([1]) child repeated element
		var mockClick = {type:"click",preventDefault: function(){}};
		bChildOfSecondCopyOfParentInstance.onRemoveLinkClick(mockClick,document.getElementById(repeatedChildElement1.id+'-wfDL'));		
		
		//Verify reindex of child elements
		var originalChildElement = document.getElementById('nestedTest5[1][0]');
		assertNotNull(originalChildElement.id);
		var repeatedChildElement1 = document.getElementById('nestedTest5[1][1]');
		assertNotNull(repeatedChildElement1.id);				
		assertEquals("1",document.getElementById('nestedTest5[1][0]-RC').value);
		
		//Delete middle ([1]) parent repeated element
		var mockClick = {type:"click",preventDefault: function(){}};
		bParentInstance.onRemoveLinkClick(mockClick,document.getElementById(repeatedElement1.id+'-wfDL'));

		//Verify removal of nested child indices after removal of parent section
		assertNull(document.getElementById('nestedTest5[1][0]-RC'));
		
		//Verify reindex of parent
		var originalElement = document.getElementById('nestedTest2[0]');
		assertNotNull(originalElement.id);
		var repeatedElement1 = document.getElementById('nestedTest2[1]');
		assertNotNull(repeatedElement1.id);				
		assertEquals("1",document.getElementById('nestedTest2[0]-RC').value);
	}	
	</script>
	
</head>

<body class="wForm">




	<h2>Repeat Behavior Test Suite</h2>


	<form method="post" action="http://app.formassembly.com/responses/testprocessor" id="testRepeatForm" style="width: 550px">
	
		<div class="repeat" id="test4">
			<div class="oneField">
				<label for="testInput4" class="preField" style="min-width:5em">RepeatRemove</label>
				<input type="text" id="testInput4" name="testInput3" value="" size="" />
				<div class="field-hint-inactive" id="testInput4-H">
					<span>Removable</span>
				</div>						
			</div>
		</div>
		
		<fieldset class="repeat" id="nestedTest2"><legend>Parent Repeat</legend>
			<div class="oneField">
				<input id="nestedTestInput4" type="text" size="40" />
			</div>
			<fieldset class="repeat" id="nestedTest5"><legend>Nested Repeat</legend>
				<div class="oneField">
					<input id="nestedTestInput6" type="text" size="40" />
				</div>
				<div class="oneField">
					<input id="nestedTestInput7" type="text" size="40" />
				</div>			
			</fieldset>
			<div class="oneField">
				<input id="nestedTestInput8" type="text"  size="40" />
			</div>
		</fieldset>		
		
	</form>
</body>
</html>


